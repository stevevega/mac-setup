{"uri":"file:///Users/vega/Code/huli/manager-web/src/library/HH/Subscription/Flow/ChangePlan.php","root":{"kind":0,"name":"","children":[{"kind":512,"name":"HH\\Subscription\\Flow","location":[11,0,11,31]},{"kind":1,"name":"ICommunication","modifiers":4096,"location":[13,5,13,33],"associated":[{"kind":1,"name":"Communication\\ICommunication"}]},{"kind":1,"name":"TCommunication","modifiers":4096,"location":[14,5,14,33],"associated":[{"kind":1,"name":"Communication\\TCommunication"}]},{"kind":1,"name":"TResponse","modifiers":4096,"location":[15,5,15,22],"associated":[{"kind":1,"name":"HH\\Http\\TResponse"}]},{"kind":1,"name":"Language","modifiers":4096,"location":[16,5,16,16],"associated":[{"kind":1,"name":"HH\\Language"}]},{"kind":1,"name":"MailSubscription","modifiers":4096,"location":[17,5,17,37],"associated":[{"kind":1,"name":"HH\\Mail\\Service\\MailSubscription"}]},{"kind":1,"name":"DoctorSideEffects","modifiers":4096,"location":[18,5,18,63],"associated":[{"kind":1,"name":"HH\\Request\\SideEffects\\Account\\Doctor"}]},{"kind":1,"name":"SubscriptionCancel","modifiers":4096,"location":[19,5,19,63],"associated":[{"kind":1,"name":"HH\\Subscription\\Model\\Actions\\Cancel"}]},{"kind":1,"name":"SubscriptionSave","modifiers":4096,"location":[20,5,20,59],"associated":[{"kind":1,"name":"HH\\Subscription\\Model\\Actions\\Save"}]},{"kind":1,"name":"SubscriptionSync","modifiers":4096,"location":[21,5,21,66],"associated":[{"kind":1,"name":"HH\\Subscription\\Model\\Actions\\Synchronize"}]},{"kind":1,"name":"SubscriptionWrapper","modifiers":4096,"location":[22,5,22,57],"associated":[{"kind":1,"name":"HH\\Subscription\\Model\\Wrapper"}]},{"kind":1,"name":"Plans","modifiers":4096,"location":[23,5,23,26],"associated":[{"kind":1,"name":"HH\\Subscription\\Plans"}]},{"kind":1,"name":"Trial","modifiers":4096,"location":[24,5,24,26],"associated":[{"kind":1,"name":"HH\\Subscription\\Trial"}]},{"kind":1,"name":"StripeTrial","modifiers":4096,"location":[25,5,25,48],"associated":[{"kind":1,"name":"HH\\Subscription\\Trial\\Stripe"}]},{"kind":1,"name":"Date","modifiers":4096,"location":[26,5,26,17],"associated":[{"kind":1,"name":"HH\\Util\\Date"}]},{"kind":1,"name":"ISession","modifiers":4096,"location":[27,5,27,33],"associated":[{"kind":1,"name":"Huli\\Authentication\\ISession"}]},{"kind":1,"name":"Transaction","modifiers":4096,"location":[28,5,28,30],"associated":[{"kind":1,"name":"Huli\\Database\\Transaction"}]},{"kind":1,"name":"DoctorModel","modifiers":4096,"location":[29,5,29,32],"associated":[{"kind":1,"name":"Model\\Doctor"}]},{"kind":1,"name":"DoctorDraft","modifiers":4096,"location":[30,5,30,38],"associated":[{"kind":1,"name":"Model\\Draft\\Doctor"}]},{"kind":1,"name":"PlanModel","modifiers":4096,"location":[31,5,31,28],"associated":[{"kind":1,"name":"Model\\Plan"}]},{"kind":1,"name":"UserModel","modifiers":4096,"location":[32,5,32,28],"associated":[{"kind":1,"name":"Model\\User"}]},{"kind":1,"name":"UserInstanceModel","modifiers":4096,"location":[33,5,33,45],"associated":[{"kind":1,"name":"Model\\User\\Instance"}]},{"kind":1,"name":"UserSubscriptionModel","modifiers":4096,"location":[34,5,34,53],"associated":[{"kind":1,"name":"Model\\User\\Subscription"}]},{"kind":1,"name":"Customer","modifiers":4096,"location":[35,5,35,21],"associated":[{"kind":1,"name":"Payment\\Customer"}]},{"kind":1,"name":"CustomerSource","modifiers":4096,"location":[36,5,36,46],"associated":[{"kind":1,"name":"Payment\\Customer\\Source"}]},{"kind":1,"name":"IProcessor","modifiers":4096,"location":[37,5,37,23],"associated":[{"kind":1,"name":"Payment\\IProcessor"}]},{"kind":1,"name":"PaymentProcessor","modifiers":4096,"location":[38,5,38,29],"associated":[{"kind":1,"name":"Payment\\PaymentProcessor"}]},{"kind":1,"name":"HH\\Subscription\\Flow\\ChangePlan","location":[45,0,1029,1],"associated":[{"kind":2,"name":"HH\\Subscription\\Flow\\IFlow"},{"kind":2,"name":"Communication\\ICommunication"},{"kind":4,"name":"HH\\Http\\TResponse"},{"kind":4,"name":"Communication\\TCommunication"}],"description":"Subscriptions flow: CHANGE PLAN\nChange subscription plan\nDifferences for user with SaaS instances","children":[{"kind":16,"name":"$params","modifiers":4,"location":[54,12,54,26],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"mixed"},{"kind":16,"name":"$current_subscription","modifiers":4,"location":[61,12,61,40],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Model\\User\\Subscription"},{"kind":16,"name":"$has_current_subscription","modifiers":4,"location":[71,12,71,44],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$new_subscription","modifiers":4,"location":[78,12,78,36],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Model\\User\\Subscription"},{"kind":16,"name":"$is_legacy_user","modifiers":4,"location":[86,12,86,35],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$user","modifiers":4,"location":[93,12,93,24],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Model\\User"},{"kind":16,"name":"$id_doctor","modifiers":4,"location":[100,12,100,29],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"int"},{"kind":16,"name":"$plan","modifiers":4,"location":[107,12,107,24],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Model\\Plan"},{"kind":16,"name":"$is_change_to_free","modifiers":4,"location":[115,12,115,38],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$is_current_plan_free","modifiers":4,"location":[122,12,122,41],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$is_paying_customer","modifiers":4,"location":[129,12,129,39],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$subscription_created","modifiers":4,"location":[136,12,136,41],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$id_new_subscription","modifiers":4,"location":[143,12,143,39],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"int"},{"kind":16,"name":"$id_current_subscription","modifiers":4,"location":[150,12,150,43],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"int"},{"kind":16,"name":"$trial_end_on","modifiers":4,"location":[157,12,157,32],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Util\\Date"},{"kind":16,"name":"$trial_ended","modifiers":4,"location":[165,12,165,31],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$current_plan_has_trial","modifiers":4,"location":[173,12,173,42],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$current_subscription_has_known_trial","modifiers":4,"location":[181,12,181,56],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$has_payment_processor_subscription","modifiers":4,"location":[189,12,189,54],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$has_previous_cards","modifiers":4,"location":[199,12,199,39],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":16,"name":"$transaction","modifiers":4,"location":[206,12,206,24],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Huli\\Database\\Transaction"},{"kind":16,"name":"$session","modifiers":4,"location":[213,12,213,20],"scope":"HH\\Subscription\\Flow\\ChangePlan","type":"Huli\\Authentication\\ISession"},{"kind":32,"name":"__construct","modifiers":1,"location":[239,4,252,5],"description":"Flow constructor as setup","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$session","location":[239,32,239,49],"scope":"__construct","typeSource":1,"type":"Huli\\Authentication\\ISession"},{"kind":128,"name":"$params","location":[239,51,239,58],"description":"setup params\nREQUIRE\n- id_user             int         doctor user id\n- plan_key            int|string  plan id or name (\\HH\\Subscription\\Plans)\n- id_user_modified_by int         modifier user id for audit controls\nREQUIRE FOR NON NEW CUSTOMER\n- customer_token      string      payment processor token\nOPTIONAL\n- forgive_invoices    boolean     (default: true) close open invoices on change to free\n- notify              boolean     (default: true) enable subscription upgrade mail\n- price               int         (default: plan price) custom plan price\n- id_stripe_customer  string      (default: copy) manually define stripe customer\n- unsync              boolean     (default: false) unsync/skip payment processor flag\n- reason_key          string      (default: other) plan cancellation reason key\n- reason_text         string      (default: null) plan cancellation reason text\n- remove_hh           boolean     (default: true) remove hulihealth instance\n- trial_end           datetime    (default: null) force trial end datetime in UTC format\n","scope":"__construct","type":"object"},{"kind":128,"name":"$t","location":[239,60,239,74],"scope":"__construct","typeSource":1,"type":"Huli\\Database\\Transaction"}]},{"kind":32,"name":"execute","modifiers":1,"location":[259,4,291,5],"description":"Flow execution trigger","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":32,"name":"notify","modifiers":1,"location":[299,4,306,5],"description":"Flow notifications trigger\nUsed mostly for trigger events like emails","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"bool"},{"kind":32,"name":"load","modifiers":4,"location":[311,4,318,5],"description":"Load models required for change plan flow","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"load_subscription","modifiers":4,"location":[325,4,351,5],"description":"Loads the subscription information in the current params","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"load_user","modifiers":4,"location":[358,4,365,5],"description":"Loads the necessary user data","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"load_doctor","modifiers":4,"location":[372,4,379,5],"description":"Loads the necessary doctor data","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"load_plan","modifiers":4,"location":[386,4,397,5],"description":"Loads the necessary plan data","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"check_plan","modifiers":4,"location":[404,4,415,5],"description":"Checks plan information","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"sync_new_subscription","modifiers":4,"location":[422,4,449,5],"description":"Copy current subscription to new properties (model sync)","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"check_subscription","modifiers":4,"location":[456,4,479,5],"description":"Checks subscription information","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"check_trial","modifiers":4,"location":[486,4,502,5],"description":"Checks wheter the subscription trial has ended","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"payment_processor_updates","modifiers":4,"location":[509,4,550,5],"description":"Apply changes at payment processor end (stripe)","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"create_subscription","modifiers":4,"location":[560,4,597,5],"description":"Creates a new stripe subscription for users that don't have one yet\nCard token is requiere for plan changes without trial period","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$processor","location":[560,41,560,62],"scope":"create_subscription","typeSource":1,"type":"Payment\\IProcessor"}]},{"kind":32,"name":"sync_has_card","modifiers":4,"location":[606,4,629,5],"description":"Verify has_card status is in sync with payment processor","scope":"HH\\Subscription\\Flow\\ChangePlan","typeSource":1,"type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$processor","location":[606,35,606,56],"scope":"sync_has_card","typeSource":1,"type":"Payment\\IProcessor"}]},{"kind":32,"name":"add_customer_card","modifiers":4,"location":[638,4,659,5],"description":"Add card passed by params as customer_token","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$processor","location":[638,39,638,60],"scope":"add_customer_card","typeSource":1,"type":"Payment\\IProcessor"}]},{"kind":32,"name":"change_subscription_plan","modifiers":4,"location":[668,4,693,5],"description":"Updates the subscription object stored in Stripe","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$processor","location":[668,46,668,67],"scope":"change_subscription_plan","typeSource":1,"type":"Payment\\IProcessor"}]},{"kind":32,"name":"forgive_open_invoices","modifiers":4,"location":[702,4,736,5],"description":"Forgive payment processor open invoices on downgrade to free","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$processor","location":[702,43,702,64],"scope":"forgive_open_invoices","typeSource":1,"type":"Payment\\IProcessor"}]},{"kind":32,"name":"get_trial_end_on_for_stripe","modifiers":4,"location":[757,4,845,5],"description":"trial_end_on getter by applying business rules\n\nPaid plan -> paid plan : old trial is kept only if it hasn't ended\nPaid plan -> free plan : trial is forcedly ended (now)\nFree plan -> paid plan : new trial is defined by stripe\nFree plan -> free plan : not possible, but ok it will be force to end now\nAny plan -> paid no trial plan : trial is terminated immediately\n\nPer sales request:\n- FREE instance users will have the opportunity to loop between free and trial\n- NON free instance users cant loop, look at next validation for more details\n\nOur business rules are not related to trial status. The user can or NOT be at ended trial state","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Util\\Date"},{"kind":32,"name":"set_has_card","modifiers":4,"location":[852,4,855,5],"description":"Mark new subscription with card","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"set_paying_customer","modifiers":4,"location":[862,4,867,5],"description":"Mark paying customer status as true","scope":"HH\\Subscription\\Flow\\ChangePlan","children":[{"kind":128,"name":"$is_paying_customer","location":[862,41,862,65],"scope":"set_paying_customer","typeSource":1,"type":"bool"}]},{"kind":32,"name":"cancel_doctor_current_subscription","modifiers":4,"location":[874,4,899,5],"description":"Updates the local doctor subscription object","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"remove_hulihealth_instance","modifiers":4,"location":[907,4,921,5],"description":"Remove Hulihealth instance (aka main instance)\nOn any plan change, remove HH instance as it needs to be reviewed","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"create_doctor_new_subscription","modifiers":4,"location":[928,4,973,5],"description":"Updates the local doctor subscription object","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"discard_trial_setup","modifiers":4,"location":[978,4,985,5],"description":"Setup flow to run by discarding the trial","scope":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"update_doctor_profile","modifiers":4,"location":[992,4,1004,5],"description":"Updates the doctor profile with the right doctor type depending on the plan","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"},{"kind":32,"name":"send_email","modifiers":4,"location":[1011,4,1028,5],"description":"Requests an email to be send to doctor and admin notifying them of changes to subscriptions","scope":"HH\\Subscription\\Flow\\ChangePlan","type":"HH\\Subscription\\Flow\\ChangePlan"}]}]}}